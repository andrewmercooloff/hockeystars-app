# Инструкция по исправлению проблемы с дублированием команд

## Проблема
В текущей версии приложения невозможно добавить одну и ту же команду несколько раз игроку, даже если это разные годы. Это происходит из-за ограничения `UNIQUE(player_id, team_id)` в базе данных.

## Решение
Мы изменили структуру базы данных, чтобы разрешить игроку играть в одной команде в разные годы, но предотвратить пересечение периодов времени.

## Шаги для применения изменений

### 1. Обновление базы данных
Выполните SQL-скрипт `database/fix_player_teams_unique_constraint_final.sql` в вашей базе данных Supabase (это финальная версия без проблемных функций):

```sql
-- Этот скрипт:
-- 1. Удаляет старое ограничение уникальности
-- 2. Создает новое ограничение, учитывающее годы
-- 3. Добавляет триггер для проверки пересечения годов
-- 4. Обновляет существующие записи
-- 5. Создает индексы для производительности
```

### 2. Что изменилось в коде
- **`utils/playerStorage.ts`**: Обновлена функция `addPlayerTeam` для проверки пересечения годов вместо простой проверки существования команды
- **Логика**: Теперь можно добавлять одну команду несколько раз с разными годами, но нельзя добавлять команду в пересекающиеся периоды времени

### 3. Как это работает
- **Старая логика**: `UNIQUE(player_id, team_id)` - игрок мог быть в команде только один раз
- **Новая логика**: `UNIQUE(player_id, team_id, start_year, end_year)` - игрок может быть в команде несколько раз с разными годами
- **Проверка пересечений**: Триггер проверяет, что периоды времени не пересекаются

### 4. Примеры использования
Теперь можно добавить:
- Команда "Динамо" в 2018-2020 годах
- Команда "Динамо" в 2022-2024 годах
- Команда "Динамо" в 2025 году (текущая)

Но нельзя добавить:
- Команда "Динамо" в 2019-2021 годах (пересекается с 2018-2020)

### 5. Проверка работы
После применения изменений:
1. Попробуйте добавить одну команду несколько раз с разными годами
2. Убедитесь, что данные сохраняются
3. Проверьте, что нельзя добавить команду в пересекающиеся периоды

## Важные замечания
- **Резервная копия**: Перед выполнением SQL-скрипта сделайте резервную копию базы данных
- **Тестирование**: Протестируйте изменения на тестовой среде перед применением на продакшене
- **Обратная совместимость**: Существующие данные будут автоматически обновлены

## Если что-то пошло не так
В случае ошибок:
1. Проверьте логи в консоли Supabase
2. Убедитесь, что у вас есть права на изменение структуры таблиц
3. При необходимости можно откатить изменения, восстановив резервную копию
