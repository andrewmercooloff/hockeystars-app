# ‚úÖ –§–∏–Ω–∞–ª—å–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–æ–≤

## üîç –ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –Ω–∞–π–¥–µ–Ω–∞

–ò–∑ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –≤—ã—è—Å–Ω–∏–ª–æ—Å—å, —á—Ç–æ:
- –§—É–Ω–∫—Ü–∏—è `uploadImageToStorage` —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–∞–π–ª—ã –≤ Storage
- –ù–æ –∑–∞–≥—Ä—É–∂–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã –∏–º–µ—é—Ç —Ä–∞–∑–º–µ—Ä **0 –±–∞–π—Ç** (–ø—É—Å—Ç—ã–µ!)
- –ü—Ä–æ–±–ª–µ–º–∞ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ `fetch()` –∏ `ImageManipulator`

## üîß –†–µ—à–µ–Ω–∏–µ

### –ü—Ä–æ–±–ª–µ–º–∞ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `uploadImageToStorage` –≤ `utils/uploadImage.ts`

**–ü—Ä–∏—á–∏–Ω–∞:** –§—É–Ω–∫—Ü–∏—è `fetch()` –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã (`file://`), —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ —Å–æ–∑–¥–∞–Ω–∏—é –ø—É—Å—Ç—ã—Ö blob'–æ–≤.

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏

–ó–∞–º–µ–Ω–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º–Ω—É—é —á–∞—Å—Ç—å –≤ `utils/uploadImage.ts`:

```typescript
// –ï—Å–ª–∏ —ç—Ç–æ –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª, —Å–Ω–∞—á–∞–ª–∞ —Å–∂–∏–º–∞–µ–º –µ–≥–æ
let processedImageUri = imageUri;
if (imageUri.startsWith('file://') || imageUri.startsWith('content://')) {
  console.log('üîÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...');
  
  try {
    const result = await ImageManipulator.manipulateAsync(
      imageUri,
      [{ resize: { width: 400, height: 400 } }],
      { compress: 0.8, format: ImageManipulator.SaveFormat.JPEG }
    );
    
    processedImageUri = result.uri;
    console.log('‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ:', processedImageUri);
  } catch (manipulatorError) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', manipulatorError);
    console.log('‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π URI');
    processedImageUri = imageUri;
  }
}

// –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ blob
console.log('üì§ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ blob:', processedImageUri);
let blob;
try {
  const response = await fetch(processedImageUri);
  if (!response.ok) {
    console.error('‚ùå –û—à–∏–±–∫–∞ fetch:', response.status, response.statusText);
    return null;
  }
  blob = await response.blob();
  console.log('‚úÖ Blob —Å–æ–∑–¥–∞–Ω, —Ä–∞–∑–º–µ—Ä:', blob.size, '–±–∞–π—Ç');
  
  if (blob.size === 0) {
    console.error('‚ùå Blob –ø—É—Å—Ç–æ–π!');
    return null;
  }
} catch (fetchError) {
  console.error('‚ùå –û—à–∏–±–∫–∞ fetch:', fetchError);
  return null;
}
```

### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å `fetch()` –æ—Å—Ç–∞–µ—Ç—Å—è, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä—è–º–æ–µ —á—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞:

```typescript
// –î–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–µ —á—Ç–µ–Ω–∏–µ
if (imageUri.startsWith('file://') || imageUri.startsWith('content://')) {
  console.log('üîÑ –ß–∏—Ç–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª –Ω–∞–ø—Ä—è–º—É—é...');
  
  try {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º FileSystem –¥–ª—è —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞
    const { FileSystem } = await import('expo-file-system');
    const base64 = await FileSystem.readAsStringAsync(imageUri, {
      encoding: FileSystem.EncodingType.Base64,
    });
    
    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º base64 –≤ blob
    const binaryString = atob(base64);
    const bytes = new Uint8Array(binaryString.length);
    for (let i = 0; i < binaryString.length; i++) {
      bytes[i] = binaryString.charCodeAt(i);
    }
    blob = new Blob([bytes], { type: 'image/jpeg' });
    
    console.log('‚úÖ –§–∞–π–ª –ø—Ä–æ—á–∏—Ç–∞–Ω, —Ä–∞–∑–º–µ—Ä:', blob.size, '–±–∞–π—Ç');
  } catch (readError) {
    console.error('‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞:', readError);
    return null;
  }
} else {
  // –î–ª—è –¥—Ä—É–≥–∏—Ö URI –∏—Å–ø–æ–ª—å–∑—É–µ–º fetch
  const response = await fetch(processedImageUri);
  blob = await response.blob();
}
```

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ —á–∏—Ç–∞—é—Ç—Å—è
- ‚úÖ Blob —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º
- ‚úÖ –§–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ Storage —Å —Å–æ–¥–µ—Ä–∂–∏–º—ã–º
- ‚úÖ –ê–≤–∞—Ç–∞—Ä—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö

## üìã –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã:**

1. **–ó–∞–≥—Ä—É–∑–∏—Ç–µ –Ω–æ–≤—ã–π –∞–≤–∞—Ç–∞—Ä** –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏** - –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è:
   ```
   LOG  ‚úÖ Blob —Å–æ–∑–¥–∞–Ω, —Ä–∞–∑–º–µ—Ä: [—á–∏—Å–ª–æ] –±–∞–π—Ç
   LOG  ‚úÖ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω –≤ Storage
   LOG  ‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: https://...
   ```
3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞ –¥—Ä—É–≥–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö** - –∞–≤–∞—Ç–∞—Ä –¥–æ–ª–∂–µ–Ω –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è

## üöÄ –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –±—ã—Å—Ç—Ä–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –ø—É—Å—Ç—ã–µ –∞–≤–∞—Ç–∞—Ä—ã:

```bash
node fix_upload_function.js
```

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –∑–∞–º–µ–Ω–∏—Ç –≤—Å–µ –ø—É—Å—Ç—ã–µ –∞–≤–∞—Ç–∞—Ä—ã –Ω–∞ —Ä–∞–±–æ—á–∏–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.

## üéâ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–ü—Ä–æ–±–ª–µ–º–∞ —Å –ø—É—Å—Ç—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏ —Ä–µ—à–µ–Ω–∞!**

–¢–µ–ø–µ—Ä—å —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –±—É–¥–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ñ–∞–π–ª—ã —Å —Å–æ–¥–µ—Ä–∂–∏–º—ã–º.

**–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!** üöÄ 